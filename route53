#!/usr/bin/env bash

set -f
set -o pipefail
set -o errexit
set -o nounset
trap 'echo "$0: line ${LINENO}: exiting because of error";exit 1' ERR

while getopts "h" options; do case $options in
  h) exit ;;
esac; done; shift $((OPTIND - 1))

[[ -r ~/.aws_tools_rc ]] && { source ~/.aws_tools_rc; }

if [[ "$#" -eq 0 ]];then
  $0 list

elif [[ "$1" == "set" ]];then
  aws route53 \
    change-resource-record-sets \
    --hosted-zone-id "$HOSTED_ZONE_ID" \
    --change-batch \
    "{\"Changes\":[{\"Action\":\"UPSERT\",\"ResourceRecordSet\":{\
\"Name\":\"${SUB_DOMAIN}\",\
\"Type\":\"A\",\
\"TTL\":60,\
\"ResourceRecords\":[{\"Value\":\"${PUBLIC_IP}\"}]\
}}]}"

elif [[ "$1" == "list" ]];then
  aws route53 \
    list-resource-record-sets \
    --hosted-zone-id "$HOSTED_ZONE_ID" \
    --query "ResourceRecordSets[?Type == 'A']"

fi

